var Tool={none:0,measurePoint:1,measureLength:2,measureArea:3,measureZ:4,measureFacade:5,measureAngle:6,measureSlope:7,createPoint:11,createPolyline:12,createPolygon:13,caliplane:14,pick:21,remove:22,fullscreen:23,lrs:24,play:31,stop:32,next:33,prev:34,branch:35,back:36,history:37};var FullMode={fill:1,trans:2,clip:3,stretch:4};var SampleMode={none:0,cloud:1,photo:2,ground:3,plane:4,object:5,depth:6};var LocateState={success:0,typeError:1,dataError:2,imageError:3,busy:4};var ControlType={arrow:0,history:1};(function(e,r){typeof exports==="object"&&typeof module!=="undefined"?r(exports):typeof define==="function"&&define.amd?define(["jquery","three","proj4","mousewheel","exports"],r):r(jQuery,THREE,proj4,null,e.PP=e.PP||{})})(this,function(e,r,t,a,i){var n={center:0,left:1,right:2};var o={stroke:0,rect:1};TextSprite=function(e){r.Object3D.call(this);var t=new r.Texture;t.minFilter=r.LinearFilter;t.magFilter=r.LinearFilter;var a=new r.SpriteMaterial({map:t,depthTest:false});this.sprite=new r.Sprite(a);this.add(this.sprite);this.text="";this.offset=[0,0];this.style={fontface:"微软雅黑",fontsize:15,textColor:"#000000",borderThickness:1,borderFillet:6,borderColor:"rgba(0,0,0,0.8)",backgroundColor:"rgba(255,255,255,0.8)"};if(e!=null){if(e.text!=null){this.text=e.text}if(e.offset!=null){this.offset[0]=e.offset[0];this.offset[1]=e.offset[1]}if(e.style!=null){if(e.style.fontface!=null)this.style.fontface=e.style.fontface;if(e.style.fontsize!=null)this.style.fontsize=e.style.fontsize;if(e.style.textColor!=null)this.style.textColor=e.style.textColor;if(e.style.borderThickness!=null)this.style.borderThickness=e.style.borderThickness;if(e.style.borderFillet!=null)this.style.borderFillet=e.style.borderFillet;if(e.style.borderColor!=null)this.style.borderColor=e.style.borderColor;if(e.style.backgroundColor!=null)this.style.backgroundColor=e.style.backgroundColor}}this.update()};TextSprite.prototype=new r.Object3D;TextSprite.prototype.setStyle=function(e){if(e.fontface!=null)this.style.fontface=e.fontface;if(e.fontsize!=null)this.style.fontsize=e.fontsize;if(e.textColor!=null)this.style.textColor=e.textColor;if(e.borderThickness!=null)this.style.borderThickness=e.borderThickness;if(e.borderFillet!=null)this.style.borderFillet=e.borderFillet;if(e.borderColor!=null)this.style.borderColor=e.borderColor;if(e.backgroundColor!=null)this.style.backgroundColor=e.backgroundColor;this.update()};TextSprite.prototype.setOffset=function(e,r){this.offset[0]=e;this.offset[1]=r;this.update()};TextSprite.prototype.setText=function(e){this.text=e;this.update()};TextSprite.prototype.update=function(){var e=this.style.fontsize+"px "+this.style.fontface;var t=document.createElement("canvas");var a=t.getContext("2d");a.font=e;var i=a.measureText(this.text);var n=i.width;var o=Math.round(this.style.fontsize*.2)+this.style.borderThickness;var s=n+2*o;var l=this.style.fontsize+2*o;var t=document.createElement("canvas");var a=t.getContext("2d");a.canvas.width=s;a.canvas.height=l;a.font=e;if(this.style.borderThickness>0){a.fillStyle=this.style.backgroundColor;a.strokeStyle=this.style.borderColor;a.lineWidth=this.style.borderThickness;this.roundRect(a,this.style.borderThickness/2,this.style.borderThickness/2,s-this.style.borderThickness,l-this.style.borderThickness,this.style.borderFillet);a.fillStyle=this.style.textColor;a.fillText(this.text,o,this.style.fontsize+o/2)}else{a.strokeStyle=this.style.backgroundColor;a.strokeText(this.text,o,this.style.fontsize+o/2);a.fillStyle=this.style.textColor;a.fillText(this.text,o,this.style.fontsize+o/2)}var c=new r.Texture(t);c.minFilter=r.LinearFilter;c.magFilter=r.LinearFilter;c.needsUpdate=true;this.sprite.material.map=c;var v=l/this.style.fontsize;var u=s/l*v;var f=1*v;var d=this.offset[0]/this.style.fontsize;var p=this.offset[1]/this.style.fontsize;this.sprite.scale.set(u,f,1);this.sprite.position.set(d,0,p)};TextSprite.prototype.roundRect=function(e,r,t,a,i,n){a--;e.beginPath();e.moveTo(r+n,t);e.lineTo(r+a-n,t);e.quadraticCurveTo(r+a,t,r+a,t+n);e.lineTo(r+a,t+i-n);e.quadraticCurveTo(r+a,t+i,r+a-n,t+i);e.lineTo(r+n,t+i);e.quadraticCurveTo(r,t+i,r,t+i-n);e.lineTo(r,t+n);e.quadraticCurveTo(r,t,r+n,t);e.closePath();e.fill();e.stroke()};RotControl=function(t,a){var i=this;var n=e(a);t.target=new r.Vector3(0,0,0);this.onRot=function(e){};var o=Math.PI*3/4;var s=true;var l=false;var c=0;var v=0;var u=0;function f(e){var r={};r.x=e.offsetLeft;r.y=e.offsetTop;while(e.offsetParent!=null){e=e.offsetParent;r.x+=e.offsetLeft;r.y+=e.offsetTop}return r}function d(e){if(e.offsetX!=null)return;var r=f(e.target);e.offsetX=e.clientX-r.x+document.body.scrollLeft;e.offsetY=e.clientY-r.y+document.body.scrollTop}var p=function(e){l=true;s=true};var h=function(e){l=false};var m=function(e){if(e.originalEvent.touches!=null){if(e.originalEvent.touches.length>=2){var n=e.originalEvent.touches[0];var o=e.originalEvent.touches[1];var f=n.clientX-o.clientX;var p=n.clientY-o.clientY;var h=Math.sqrt(f*f+p*p);var m=h-u;u=h;if(s){s=false;return}if(m>0&&t.fov>5){t.fov*=.99;t.updateProjectionMatrix()}else if(m<0&&t.fov<90){t.fov*=1.01;t.updateProjectionMatrix()}return}else if(e.originalEvent.touches.length>=1){e=e.originalEvent.touches[0];d(e);e.buttons=1}else{return}}var y=e.offsetX-c;var w=e.offsetY-v;c=e.offsetX;v=e.offsetY;if(s){s=false;return}if(i.enabled==false)return;if(e.buttons==0)return;if(!l)return;var b=.02*t.fov*y/a.clientHeight;var g=.02*t.fov*w/a.clientHeight;var x=t.getWorldDirection();var k=new r.Vector3(0,0,1);var M=new r.Vector3;M.crossVectors(x,k);M.normalize();var P=new r.Quaternion;P.setFromAxisAngle(M,g);var L=new r.Quaternion;L.setFromAxisAngle(k,b);var T=new r.Vector3;T.copy(x);T.applyQuaternion(P);if(Math.abs(T.z)<.9)x.applyQuaternion(P);x.applyQuaternion(L);var S=t.position;var z=new r.Vector3;z.addVectors(S,x);t.up.set(0,0,1);t.lookAt(z);var x=t.getWorldDirection();var V=Math.atan2(x.x,x.y)*180/Math.PI;var F=Math.asin(x.z)*180/Math.PI;var I=t.fov;var C=Math.atan(Math.tan(I/2)*t.aspect)*2*180/Math.PI;var E={heading:V,pitch:F,fovx:C,dir:x};i.onRot(E)};this.dispose=function(){n.unbind("mousemove",m);n.unbind("mousedown",p);n.unbind("mouseup",h)};n.bind("mousemove",m);n.bind("mousedown",p);n.bind("mouseup",h);n.bind("touchmove",m);n.bind("touchstart",p);n.bind("touchend",h);this.enabled=false};(function(e,r,t){var a=e([]),i=e.resize=e.extend(e.resize,{}),n,o="setTimeout",s="resize",l=s+"-special-event",c="delay",v="throttleWindow";i[c]=250;i[v]=true;e.event.special[s]={setup:function(){if(!i[v]&&this[o]){return false}var r=e(this);a=a.add(r);e.data(this,l,{w:r.width(),h:r.height()});if(a.length===1){u()}},teardown:function(){if(!i[v]&&this[o]){return false}var r=e(this);a=a.not(r);r.removeData(l);if(!a.length){clearTimeout(n)}},add:function(r){if(!i[v]&&this[o]){return false}var a;function n(r,i,n){var o=e(this),s=e.data(this,l);s.w=i!==t?i:o.width();s.h=n!==t?n:o.height();a.apply(this,arguments)}if(e.isFunction(r)){a=r;return n}else{a=r.handler;r.handler=n}}};function u(){n=r[o](function(){a.each(function(){var r=e(this),t=r.width(),a=r.height(),i=e.data(this,l);if(t!==i.w||a!==i.h){r.trigger(s,[i.w=t,i.h=a])}});u()},i[c])}})(jQuery,this);e.postJSON=function(r,t,a,i){e.ajax({type:"POST",contentType:"application/json;charset=utf-8",url:r,data:JSON.stringify(t),dataType:"json",error:i,success:a})};function s(a){var i=this;this.getVersion=function(){return"20171121"};console.log("ppv:"+i.getVersion());var n=e("#"+a);var o=document.getElementById(a);var s;var l="";var c=3;var v=1;var u=Tool.none;var f=SampleMode.photo;var d=false;var p=false;var h=0;var m;var y;var w=-1.45;var b=50;var g=100;var x=8.4456;var k=7.0656;var M=5;var P=x/k;var L=0;var T=0;var S;var z;function V(){var e=document.scripts;var r="";for(var t=e.length-1;t>=0;t--){var a=e[t].src;var i=a.toLowerCase().indexOf("ppv/js/ppv.");if(i>=0){r=a.substring(0,i);break}}return r}var F=V();var I=new r.TextureLoader;var C;var E;var B;var A;var G=new r.Group;var D=new r.Group;var H=new r.Group;var _=new r.Group;var O=new r.Group;var N=new r.Group;var j=new r.Group;var W=new r.Group;var R=new r.Group;var U=new r.Group;var Y=new r.Group;var q=new r.Group;var Q="+proj=merc +lat_0=0 +lon_0=0 +k=1.000000 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs ";var J=t(Q);var X=new r.Vector3;var Z=new r.Vector3;var K=new r.Group;var $;var ee;var re=new r.PlaneBufferGeometry(1,1);var te=new r.SphereBufferGeometry(1,32,32);var ae=new r.MeshLambertMaterial({color:16711935,side:r.FrontSide,shading:r.SmoothShading});var ie=new r.SphereBufferGeometry(1,100,50);var ne=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,shading:r.SmoothShading});var oe=new r.RingGeometry(1,1.2,64);var se=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:true,opacity:.6});var le=new r.Mesh(oe,se);var ce=new TextSprite({style:{textColor:"#ffff88",borderThickness:0,backgroundColor:"#000000"}});Y.add(le);Y.add(ce);function ve(e){e.minFilter=r.LinearFilter;e.magFilter=r.LinearFilter;e.generateMipmaps=false;e.mapping=r.UVMapping}var ue=I.load(F+"ppv/icon/arrow-e.png");ve(ue);var fe=I.load(F+"ppv/icon/arrow-w.png");ve(fe);var de=I.load(F+"ppv/icon/arrow-s.png");ve(de);var pe=I.load(F+"ppv/icon/arrow-n.png");ve(pe);var he=I.load(F+"ppv/icon/arrow-ne.png");ve(he);var me=I.load(F+"ppv/icon/arrow-nw.png");ve(me);var ye=I.load(F+"ppv/icon/arrow-se.png");ve(ye);var we=I.load(F+"ppv/icon/arrow-sw.png");ve(we);var be=I.load(F+"ppv/icon/history.png");ve(we);function ge(e){if(e>=-22.5&&e<22.5)return pe;else if(e>=22.5&&e<67.5)return he;else if(e>=67.5&&e<112.5)return ue;else if(e>=112.5&&e<157.5)return ye;else if(e>=157.5||e<-157.5)return de;else if(e>=-157.5&&e<-112.5)return we;else if(e>=-112.5&&e<-67.5)return fe;else if(e>=-67.5&&e<-22.5)return me}var xe=F+"ppv/icon/error-imaj.jpg";var ke=I.load(xe);ve(ke);error_360_url=F+"ppv/icon/error-360.jpg";var Me=I.load(error_360_url);ve(Me);var Pe=new r.Raycaster;var Le=new r.Vector2;var Te=new r.Vector2(-1,-1);var Se=new r.Vector2(-1,-1);var ze=new r.Vector2(0,0);var Ve;var Fe;var Ie={bgcolor:0,fullView:FullMode.fill,enableArrow:true,enableHistory:true,enableSurfaceDetection:true,enableDeviceOrientation:false,scope:100,thumb:"Middle",magnifier:{size:256,zoom:5,fix:false},arrows:{forward:5,below:1.8,lean:15},key:{del:46,play:32,fforward:33,fbackward:34,forward:38,backward:40,fullscreen:120},label:{fontface:"微软雅黑",fontsize:15,textColor:"#000000",borderThickness:1,borderFillet:6,borderColor:"rgba(0,0,0,0.8)",backgroundColor:"rgba(255,255,255,0.8)"}};this.setPref=function(e){if(e.bgcolor!=null){Ie.bgcolor=e.bgcolor;A.setClearColor(Ie.bgcolor)}if(e.fullView!=null){Ie.fullView=e.fullView}if(e.enableArrow!=null){Ie.enableArrow=e.enableArrow;_.visible=Ie.enableArrow}if(e.enableHistory!=null){Ie.enableHistory=e.enableHistory;O.visible=Ie.enableArrow}if(e.enableSurfaceDetection!=null){Ie.enableSurfaceDetection=e.enableSurfaceDetection;Y.visible=Ie.enableSurfaceDetection}if(e.enableDeviceOrientation!=null){Ie.enableDeviceOrientation=e.enableDeviceOrientation}if(e.scope!=null){Ie.scope=e.scope;g=Ie.scope/M;var t=new r.Vector3(0,M*g,0);var a=new r.Euler(Math.PI/2,0,0);var i=new r.Vector3(x*g,k*g,1);$.rotation.copy(a);$.scale.copy(i);$.position.copy(t);ee.scale.set(-Ie.scope,Ie.scope,Ie.scope)}if(e.arrows){if(e.arrows.forward!=null){Ie.arrows.forward=e.arrows.forward}if(e.arrows.below!=null){Ie.arrows.below=e.arrows.below}if(e.arrows.lean!=null){Ie.arrows.lean=e.arrows.lean}}if(e.magnifier){if(e.magnifier.size!=null){Ie.magnifier.size=e.magnifier.size}if(e.magnifier.zoom!=null){Ie.magnifier.zoom=e.magnifier.zoom}if(e.magnifier.fix!=null){Ie.magnifier.fix=e.magnifier.fix}}if(e.key){if(e.key.del!=null){Ie.key.del=e.key.del}if(e.key.play!=null){Ie.key.play=e.key.play}if(e.key.fforward!=null){Ie.key.fforward=e.key.fforward}if(e.key.fbackward!=null){Ie.key.fbackward=e.key.fbackward}if(e.key.forward!=null){Ie.key.forward=e.key.forward}if(e.key.backward!=null){Ie.key.backward=e.key.backward}if(e.key.fullscreen!=null){Ie.key.fullscreen=e.key.fullscreen}}if(e.label){if(e.label.fontface!=null)Ie.label.fontface=e.label.fontface;if(e.label.fontsize!=null)Ie.label.fontsize=e.label.fontsize;if(e.label.textColor!=null)Ie.label.textColor=e.label.textColor;if(e.label.borderThickness!=null)Ie.label.borderThickness=e.label.borderThickness;if(e.label.borderFillet!=null)Ie.label.borderFillet=e.label.borderFillet;if(e.label.borderColor!=null)Ie.label.borderColor=e.label.borderColor;if(e.label.backgroundColor!=null)Ie.label.backgroundColor=e.label.backgroundColor}};this.getPref=function(){return Ie};this.isPlaying=function(){return d};this.setServer=function(r){l=r;S=null;e.postJSON(l+"/GetEquipParam",{name:""},function(r){S=e.parseJSON(r.d)},function e(r,t){console.warn("GetEquipParam error")})};this.locate=function(r,t,a,i){s=i;if(p){var n={state:LocateState.busy};this.onLocate(n);return}p=true;Zr();c=r;switch(c){case-1:{var o=50;var v=15;e.get("php/locate.php",{lon:t,lat:a,tol:o,angle:v},function(e){var r=e.substr(0,6);if(r=="error:"){console.error(e);p=false;return}it(e,true)})}break;case 0:{e.postJSON(l+"/GetBranchByCoord",{type:c,x:t,y:a,key:s},function(e){et(e.d,true)},function e(r,t){p=false})}break;case 3:{e.postJSON(l+"/GetBranchByCoord",{type:c,x:t,y:a,key:s},function(e){nt(e.d,true)},function e(r,t){p=false})}break;case 4:{e.postJSON(l+"/GetBranchByCoord",{type:c,x:t,y:a,key:s},function(e){ot(e.d,true)},function e(r,t){p=false})}break}};this.locateByID=function(r,t,a){s=a;if(p){var i={state:LocateState.busy};this.onLocate(i);return}p=true;Zr();c=r;switch(c){case-1:{var n=50;var o=15;e.get(l+"/locate_by_id.php",{id:t,tol:n,angle:o},function(e){var r=e.substr(0,6);if(r=="error:"){console.error(e);p=false;return}it(e,true)})}break;case 0:{e.postJSON(l+"/GetBranchByID",{type:c,id:t,step:1,key:s},function(e){et(e.d,true)},function e(r,t){p=false})}break;case 100:{et(t,true)}break;case 3:{e.postJSON(l+"/GetBranchByID",{type:c,id:t,step:1,key:s},function(e){nt(e.d,true)},function e(r,t){p=false})}break;case 4:{e.postJSON(l+"/GetBranchByID",{type:c,id:t,step:1,key:s},function(e){ot(e.d,true)},function e(r,t){p=false})}break}};function Ce(r,t){if(p){return}p=true;Zr();setTimeout(function(){switch(c){case-1:{var t=50;var a=15;e.get(l+"/locate_by_id.php",{id:r,tol:t,angle:a},function(e){var r=e.substr(0,6);if(r=="error:"){console.error(e);p=false;return}it(e)})}break;case 0:{e.postJSON(l+"/GetBranchByID",{type:c,id:r,step:1,key:s},function(e){et(e.d)},function e(r,t){p=false})}break;case 3:{e.postJSON(l+"/GetBranchByID",{type:c,id:r,step:1,key:s},function(e){nt(e.d)},function e(r,t){p=false})}break;case 4:{e.postJSON(l+"/GetBranchByID",{type:c,id:r,step:1,key:s},function(e){ot(e.d)},function e(r,t){p=false})}break}},100)}function Ee(e){if(m!=null){if(e==1){switch(c){case-1:if(m.next)return m.next.id;break;case 0:if(m.Nextframe)return m.Nextframe.ImgId;break;case 3:if(m.Nextframe)return m.Nextframe.PmId;break;case 4:if(m.Nextframe)return m.Nextframe.Id;break}}else if(e==-1){switch(c){case-1:if(m.prev)return m.prev.id;break;case 0:if(m.Prevframe)return m.Prevframe.ImgId;break;case 3:if(m.Prevframe)return m.Prevframe.PmId;break;case 4:if(m.Prevframe)return m.Prevframe.Id;break}}else{}}return h+e}this.step=function(e){if(d)return;Ce(Ee(e))};this.play=function(){if(d)return;var e={tool:Tool.play};this.onTool(e);d=true;Ce(Ee(1))};this.stop=function(){d=false;var e={tool:Tool.stop};this.onTool(e)};this.setTool=function(e){pr(e)};this.getTool=function(){return u};this.setSampleMode=function(e){f=e};this.getSampleMode=function(){return f};this.getFrame=function(){return h};this.lookAt=function(e,t,a){if(!Br())return;var i=[e,t];var n=J.forward(i);var o=new r.Vector3(n[0]-X.x,n[1]-X.y,a-X.z);var s=C.getWorldDirection();var l=new r.Vector3;l.subVectors(o,C.position);l.normalize();var c=s.distanceTo(l);if(c<.1){var v=0;var u=30;var f=new r.Vector3;var d=setInterval(function(){if(++v==u){clearInterval(d)}var e=1*v/u;f.x=s.x+(l.x-s.x)*e;f.y=s.y+(l.y-s.y)*e;f.z=s.z+(l.z-s.z)*e;f.normalize();var t=new r.Vector3(0,0,1);C.position.set(0,0,0);C.up.copy(t);C.lookAt(f);C.position.copy(Z);Kr()},20)}else{var v=0;var u=30;var f=new r.Vector3;var p=new r.Quaternion;var h=new r.Quaternion;h.setFromUnitVectors(s,l);var d=setInterval(function(){if(++v==u){clearInterval(d)}var e=1*v/u;p.slerp(h,e);f.copy(s);f.applyQuaternion(p);f.normalize();var t=new r.Vector3(0,0,1);C.position.set(0,0,0);C.up.copy(t);C.lookAt(f);C.position.copy(Z);Kr()},20)}};this.undo=function(){var e={button:1};switch(u){case Tool.measurePoint:tr(Le,e);break;case Tool.measureLength:ar(Le,e);break;case Tool.measureArea:nr(Le,e);break;case Tool.measureZ:or(Le,e);break;case Tool.measureFacade:sr(Le,e);break;case Tool.measureAngle:lr(Le,e);break;case Tool.measureSlope:cr(Le,e);break;case Tool.createPoint:$e(Le,e);break;case Tool.createPolyline:er(Le,e);break;case Tool.createPolygon:rr(Le,e);break;case Tool.pick:Ze(Le,e);break;case Tool.remove:Ke(Le,e);break}};this.finish=function(){var e={button:2};switch(u){case Tool.measurePoint:tr(Le,e);break;case Tool.measureLength:ar(Le,e);break;case Tool.measureArea:nr(Le,e);break;case Tool.measureZ:or(Le,e);break;case Tool.measureFacade:sr(Le,e);break;case Tool.measureAngle:lr(Le,e);break;case Tool.measureSlope:cr(Le,e);break;case Tool.createPoint:$e(Le,e);break;case Tool.createPolyline:er(Le,e);break;case Tool.createPolygon:rr(Le,e);break;case Tool.pick:Ze(Le,e);break;case Tool.remove:Ke(Le,e);break}};this.addLayer=function(e){var t=q.getObjectByName(name);if(t=null)return;t=new r.Group;t.name=e.name;t.userData=e;if(e.type=="Point"){var a=e.icon;if(a==null){a=F+"ppv/icon/disc.png"}t.texture=I.load(a)}q.add(t);return t};this.findLayer=function(e){var r=q.getObjectByName(e);if(r==null)return;return r};this.getLayer=function(e){var r=e;return r.userData};this.setLayer=function(e,r){var t=e;t.name=r.name;t.userData=r;if(r.type=="Point"){var a=r.icon;if(a==null){a=F+"ppv/icon/disc.png"}t.texture=I.load(a)}for(var i=0;i<t.children.length;i++){var n=t.children[i];this.setFeature(n,n.userData)}};this.removeLayer=function(e){var r=e;q.remove(r)};this.removeAllLayers=function(){q.children=[]};this.needsUpdate=false;function Be(e,t,a){var i=e.userData;var n=t.geometry.coordinates;var o=J.forward(n);var s=new r.Vector3(0,0,0);if(t.toGround!=null){s.set(o[0]-X.x,o[1]-X.y,C.position.z+t.toGround+w)}else{s.set(o[0]-X.x,o[1]-X.y,n[2]-X.z)}var l=new r.SpriteMaterial({map:e.texture,color:i.color,opacity:i.opacity});e.material=l;var c=new r.Sprite(e.material);c.position.copy(s);c.updateMatrixWorld(true);a.add(c);if(t.name!=null&&t.name.length>0){var v=new TextSprite({text:t.name,offset:[0,-(i.fontSize*1.2+i.size)/2],style:Ie.label});v.setStyle({fontsize:i.fontSize});v.position.copy(s);v.updateMatrixWorld(true);a.add(v)}return a}function Ae(e,t,a){var i=t.geometry.coordinates;var n=new r.Vector3(0,0,0);var o=0;for(var s=0;s<i.length;s++){var l=i[s];var c=J.forward(l);var v=new r.Vector3(0,0,0);if(t.toGround!=null){v.set(c[0]-X.x,c[1]-X.y,C.position.z+t.toGround+w)}else{v.set(c[0]-X.x,c[1]-X.y,l[2]-X.z)}n.add(v);o++;var u=new r.Vector3(0,0,0);if(e.offset!=null)u.set(e.offset[0]/e.size,0,e.offset[1]/e.size);if(e.icon!=null){var f=I.load(e.icon);var d=new r.SpriteMaterial({map:f,color:e.color,opacity:e.opacity});var p=new r.Sprite(d);p.position.copy(u);var h=new r.Group;h.add(p);h.position.copy(v);a.add(h)}else{var m=new r.MeshStandardMaterial({color:e.color,opacity:e.opacity,side:r.FrontSide,shading:r.SmoothShading});var y=new r.Mesh(te,m);y.position.copy(v);a.add(y)}}if(t.name!=null&&t.name.length>0){var b=new TextSprite({text:t.name,offset:[0,-(e.fontSize*1.2+e.size)/2],style:Ie.label});b.setStyle({fontsize:e.fontSize});n.x/=o;n.y/=o;n.z/=o;b.position.copy(n);a.add(b)}return a}function Ge(e,t,a){var i=t.geometry.coordinates;var n=new r.Geometry;for(var o=0;o<i.length;o++){var s=i[o];var l=J.forward(s);if(t.toGround!=null){var c=new r.Vector3(l[0]-X.x,l[1]-X.y,C.position.z+t.toGround+w);n.vertices.push(c)}else{var c=new r.Vector3(l[0]-X.x,l[1]-X.y,s[2]-X.z);n.vertices.push(c)}}var v=new r.LineBasicMaterial({color:e.color,opacity:e.opacity,linewidth:e.lineWidth});var u=new r.Line(n,v);a.add(u);if(t.name!=null&&t.name.length>0){var f=new TextSprite({text:t.name,style:Ie.label});f.setStyle({fontsize:e.fontSize});n.computeBoundingBox();var d=n.boundingBox.getCenter();f.position.copy(d);a.add(f)}return a}function De(e,t,a){var i=t.geometry.coordinates;var n=new r.Vector3(0,0,0);var o=0;for(var s=0;s<i.length;s++){var l=i[s];var c=new r.Geometry;for(var v=0;v<l.length;v++){var u=l[v];var f=J.forward(u);var d=new r.Vector3(0,0,0);if(t.toGround!=null){d.set(f[0]-X.x,f[1]-X.y,C.position.z+t.toGround+w)}else{d.set(f[0]-X.x,f[1]-X.y,u[2]-X.z)}n.add(d);o++;c.vertices.push(d)}var p=new r.LineBasicMaterial({color:e.color,opacity:e.opacity,linewidth:e.lineWidth});var h=new r.Line(c,p);a.add(h)}if(t.name!=null&&t.name.length>0){var m=new TextSprite({text:t.name,style:Ie.label});m.setStyle({fontsize:e.fontSize});n.x/=o;n.y/=o;n.z/=o;m.position.copy(n);a.add(m)}return a}function He(e,t,a){var i=t.geometry.coordinates;var n=new r.LineBasicMaterial({color:e.color,opacity:e.opacity,linewidth:e.lineWidth});var o;for(var s=0;s<i.length;s++){var l=i[s];var c=new r.Geometry;for(var v=0;v<l.length;v++){var u=l[v];var f=J.forward(u);if(t.toGround!=null){var d=new r.Vector3(f[0]-X.x,f[1]-X.y,C.position.z+t.toGround+w);c.vertices.push(d)}else{var d=new r.Vector3(f[0]-X.x,f[1]-X.y,u[2]-X.z);c.vertices.push(d)}}var p=new r.Line(c,n);a.add(p);if(t.toGround!=null){var h=c.vertices[0];var m=[];for(var v=0;v<c.vertices.length;v++){var y=new r.Vector3;y.copy(c.vertices[v]);y.sub(h);m.push(y)}if(!o){o=new r.Shape(m)}else{var b=new r.Path(m);o.holes.push(b)}}}if(o){var g=new r.ShapeBufferGeometry(o);var n=new r.MeshBasicMaterial({color:65535,transparent:true,opacity:.5,side:r.DoubleSide});var x=new r.Mesh(g,n);x.position.copy(h);a.add(x)}if(t.name!=null&&t.name.length>0){var k=new TextSprite({text:t.name,style:Ie.label});k.setStyle({fontsize:e.fontSize});var c=a.children[0].geometry;c.computeBoundingBox();var M=c.boundingBox.getCenter();k.position.copy(M);a.add(k)}return a}function De(e,r,t){console.warn("N/A: MultiLineString")}function _e(e,r,t){console.warn("N/A: GeometryCollection")}this.addFeature=function(e,t){var a=e;var i=a.userData;var n=new r.Group;n.userData=t;var o=t.type;if(o=="Feature"){var s=t.geometry.type;if(s=="Point"){Be(a,t,n)}else if(s=="LineString"){Ge(i,t,n)}else if(s=="Polygon"){He(i,t,n)}else if(s=="MultiPoint"){Ae(i,t,n)}else if(s=="MultiLineString"){De(i,t,n)}else if(s=="MultiPolygon"){parseMultiPolygon(i,t,n)}else if(s=="GeometryCollection"){_e(i,t,n)}}else if(o=="FeatureCollection"){}a.add(n);return n};this.findFeature=function(e){for(var r=0;r<q.children.length;r++){var t=q.children[r];for(var a=0;a<t.children.length;a++){var i=t.children[a];if(i.userData.fid==e)return i}}};this.getFeature=function(e){var r=e;return r.userData};this.setFeature=function(e,r){var t=e;t.children=[];var a=t.parent;var i=a.userData;t.userData=r;var n=r.type;if(n=="Feature"){var o=r.geometry.type;if(o=="Point"){Be(a,r,t)}else if(o=="LineString"){Ge(i,r,t)}else if(o=="Polygon"){He(i,r,t)}else if(o=="MultiPoint"){Ae(i,r,t)}else if(o=="MultiLineString"){De(i,r,t)}else if(o=="MultiPolygon"){parseMultiPolygon(i,r,t)}else if(o=="GeometryCollection"){_e(i,r,t)}}else if(n=="FeatureCollection"){}if(Fe==t){Je(Fe)}return t};this.removeFeature=function(e){var r=e;r.parent.remove(r)};this.removeAllFeatures=function(e){var r=e;r.children=[]};this.selectFeature=function(e){var r=e;if(Fe!=r){if(Fe)Fe.children[0].material.color.setHex(Fe.children[0].currentHex);Fe=r;Fe.children[0].currentHex=Fe.children[0].material.color.getHex();Fe.children[0].material.color.setHex(16711680)}};this.visible=function(e,r){e.visible=r};this.onLocate=function(e){};this.onPosition=function(e){};this.onEye=function(e){};this.onFeatureCreate=function(e){};this.onFeatureSelect=function(e){};this.onFeatureRemove=function(e){};this.onMeasure=function(e){};this.onTool=function(e){};this.onRender=function(e){};function Oe(e){if(Ie.magnifier.fix){var t={x:Se.x-Ie.magnifier.size*.5,y:Se.y-Ie.magnifier.size*.5,w:Ie.magnifier.size,h:Ie.magnifier.size};var a=new r.Vector2;a.x=(e.x-t.x)/t.w*2-1;a.y=(e.y-t.y)/t.h*2-1;return a}else{var i=new r.Vector2(Se.x+(e.x-Se.x)/Ie.magnifier.zoom,Se.y+(e.y-Se.y)/Ie.magnifier.zoom);var n=new r.Vector2;i.x=i.x/o.clientWidth*2-1;i.y=i.y/o.clientHeight*2-1;return i}}function Ne(e){Le.x=e.offsetX/o.clientWidth*2-1;Le.y=-(e.offsetY/o.clientHeight)*2+1}function je(e){var r={};r.x=e.offsetLeft;r.y=e.offsetTop;while(e.offsetParent!=null){e=e.offsetParent;r.x+=e.offsetLeft;r.y+=e.offsetTop}return r}function We(e){if(e.offsetX!=null)return;var r=je(e.target);e.offsetX=e.clientX-r.x+document.body.scrollLeft;e.offsetY=e.clientY-r.y+document.body.scrollTop}function Re(e,r,t,a){var i=1/Math.tan(r/2)/t;i=i*a/2;return e*i}function Ue(e,r){switch(f){case SampleMode.photo:qe(e,r);break;case SampleMode.ground:Qe(e,r);break;case SampleMode.depth:Ye(e,r);break}}function Ye(t,a){if(E.visible){Pe.setFromCamera(ze,E)}else{Pe.setFromCamera(t,C)}var i=Pe.ray;var n=new r.Quaternion;n.setFromEuler(K.rotation);n.inverse();i.direction.applyQuaternion(n);e.postJSON(l+"/SarchDepth",{type:c,id:h,v0:i.direction.x,v1:i.direction.y,v2:i.direction.z},function(t){console.log(t.d);var i=e.parseJSON(t.d);var n=100;var o=(65535-i.depth)*n/65536;var s=new r.Vector3(i.v0*o,i.v1*o,i.v2*o);s.applyEuler(K.rotation);s.add(K.position);a(s)},function e(r,t){console.warn("SarchDepth error")})}function qe(e,t){if(E.visible){Pe.setFromCamera(ze,E)}else{Pe.setFromCamera(e,C)}var a=Pe.ray;if(j.children.length==0){var i=[new r.Vector3(0,0,0),new r.Vector3(0,0,0)];var n=new r.Vector3;n.copy(a.direction);n.setLength(100);i[0].copy(C.position);i[1].copy(C.position).add(n);var o=new r.LineBasicMaterial({color:16777215,opacity:1,linewidth:3,vertexColors:r.VertexColors});var s=new r.Geometry;s.vertices=i;s.colors.push(new r.Color(65280),new r.Color(16711680));var l=new r.Line(s,o);j.add(l);var c=Ee(-1);Ce(c)}else{var v=j.children[0].geometry;var u=[new r.Vector3(0,0,0),new r.Vector3(0,0,0)];var f=a.distanceSqToSegment(v.vertices[0],v.vertices[1],u[0],u[1]);var d=u[0].lerp(u[1],.5);j.children=[];var c=Ee(1);Ce(c);t(d)}}function Qe(e,t){if(E.visible){Pe.setFromCamera(ze,E)}else{Pe.setFromCamera(e,C)}var a=Pe.ray;var i=new r.Plane(new r.Vector3(0,0,-1),C.position.z+w);var n=a.intersectPlane(i);if(n!=null)t(n)}function Je(e){for(var r=0;r<e.children.length;r++){var t=e.children[r];if(t.material){t.currentHex=t.material.color.getHex();t.material.color.setHex(16711680)}Je(t)}}function Xe(e){for(var r=0;r<e.children.length;r++){var t=e.children[r];if(t.material){t.material.color.setHex(t.currentHex)}Xe(t)}}function Ze(e,r){if(E.visible){Pe.setFromCamera(ze,E)}else{Pe.setFromCamera(e,C)}var t=Pe.intersectObject(q,true);if(t.length>0){var a=t[0].object;while(!a.userData.geometry){a=a.parent}if(Fe!=a){if(Fe){Xe(Fe)}Fe=a;Je(Fe);var r={layer:a.parent,feature:a,layername:a.parent.name,fid:a.userData.fid};i.onFeatureSelect(r)}}else{if(Fe){Xe(Fe)}Fe=null}}function Ke(e,r){switch(r.button){case 0:{Ze(e,r)}break;case 1:{}break;case 2:{if(Fe){var t=Fe;var r={layer:t.parent,feature:t,layername:t.parent.name,fid:t.userData.fid};i.onFeatureRemove(r);if(r.cancel)return;i.removeFeature(t);Fe=null}}break}}function $e(e,r){Ue(e,function(e){var r=[e.x+X.x,e.y+X.y];var t=J.inverse(r);t[2]=e.z+X.z;var a={type:"Feature",geometry:{type:"Point",coordinates:t}};ur();i.onFeatureCreate(a)})}function er(e,t){switch(t.button){case 0:{Ue(e,function(e){if(N.children.length==0){var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices.push(e);var i=new r.Line(a,t);N.add(i)}else{var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices=N.children[0].geometry.vertices.slice(0);a.vertices.push(e);var i=new r.Line(a,t);N.children=[];N.add(i)}var n=new r.Mesh(te,ae);n.position.copy(e);W.add(n)})}break;case 1:{if(N.children.length>0){var a=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var n=new r.Geometry;n.vertices=N.children[0].geometry.vertices.slice(0);n.vertices.pop();var o=new r.Line(n,a);N.children=[];N.add(o);W.children.pop()}}break;case 2:{if(N.children.length==0)return;var n=N.children[0].geometry;if(n.vertices.length<2)return;var s=[];for(var l=0;l<n.vertices.length;l++){var c=n.vertices[l];var v=[c.x+X.x,c.y+X.y];var u=J.inverse(v);u[2]=c.z+X.z;s[l]=u}var f={type:"Feature",geometry:{type:"LineString",coordinates:s}};ur();i.onFeatureCreate(f)}break}}function rr(e,t){switch(t.button){case 0:{Ue(e,function(e){if(N.children.length==0){var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices.push(e);a.vertices.push(a.vertices[0]);var i=new r.Line(a,t);N.add(i)}else{var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices=N.children[0].geometry.vertices.slice(0);a.vertices.pop();a.vertices.push(e);a.vertices.push(a.vertices[0]);var i=new r.Line(a,t);N.children=[];N.add(i)}var n=new r.Mesh(te,ae);n.position.copy(e);W.add(n)})}break;case 1:{if(N.children.length>0){var a=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var n=new r.Geometry;n.vertices=N.children[0].geometry.vertices.slice(0);n.vertices.pop();n.vertices.pop();n.vertices.push(n.vertices[0]);var o=new r.Line(n,a);N.children=[];N.add(o);W.children.pop()}}break;case 2:{if(N.children.length==0)return;var n=N.children[0].geometry;if(n.vertices.length<2)return;var s=[];for(var l=0;l<n.vertices.length;l++){var c=n.vertices[l];var v=[c.x+X.x,c.y+X.y];var u=J.inverse(v);u[2]=c.z+X.z;s[l]=u}var f={type:"Feature",geometry:{type:"Polygon",coordinates:[s]}};ur();i.onFeatureCreate(f)}break}}function tr(e,t){Ue(e,function(e){var t=[e.x+X.x,e.y+X.y,e.z+X.z];var a=J.inverse(t);var n="lon "+a[0].toFixed(8)+"° lat "+a[1].toFixed(8)+"° alt "+t[2].toFixed(2)+" m";var o=new TextSprite({text:n,offset:[0,Ie.label.fontsize*1.2],style:Ie.label});o.position.copy(e);vr();U.add(o);var s=new r.Mesh(te,ae);s.position.copy(e);W.children=[];W.add(s);var l={lonlat:[a[0],a[1],e.z+X.z]};i.onMeasure(l)})}function ar(e,t){switch(t.button){case 0:{Ue(e,function(e){if(N.children.length==0){var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices.push(e);var n=new r.Line(a,t);N.add(n)}else{var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices=N.children[0].geometry.vertices.slice(0);a.vertices.push(e);var n=new r.Line(a,t);N.children=[];N.add(n);if(a.vertices.length>1){var o=0;for(var s=1;s<a.vertices.length;s++){var l=a.vertices[s-1];var c=a.vertices[s];o+=l.distanceTo(c)}var v=o.toFixed(2)+" m";var u=new TextSprite({text:v,style:Ie.label});a.computeBoundingBox();var f=a.boundingBox.getCenter();u.position.copy(f);vr();U.add(u);var d={length:o};i.onMeasure(d)}else{vr()}}var p=new r.Mesh(te,ae);p.position.copy(e);W.add(p)})}break;case 1:{if(N.children.length>0){var a=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var n=new r.Geometry;n.vertices=N.children[0].geometry.vertices.slice(0);n.vertices.pop();var o=new r.Line(n,a);N.children=[];N.add(o);W.children.pop();if(n.vertices.length>1){var s=0;for(var l=1;l<n.vertices.length;l++){var c=n.vertices[l-1];var v=n.vertices[l];s+=c.distanceTo(v)}var u=s.toFixed(2)+" m";var f=new TextSprite({text:u,style:Ie.label});n.computeBoundingBox();var d=n.boundingBox.getCenter();f.position.copy(d);vr();U.add(f);var t={length:s};i.onMeasure(t)}else{vr()}}}break;case 2:{}break}}function ir(e,t,a,i){var n=new r.Vector3(0,0,0);var o=new r.Vector3(0,0,0);if(a){n.z=1}else{var s=[Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)];if(s[0]<s[1]){if(s[0]<s[2])n.x=1;else n.z=1}else{if(s[1]<s[2])n.y=1;else n.z=1}}o.crossVectors(e,n).normalize();n.crossVectors(o,e).normalize();var l=new r.Matrix4;if(i!=null){if(i=="z"||i=="xy")l.makeBasis(n,o,e);else if(i=="y"||i=="xz")l.makeBasis(o,e,n);else if(i=="x"||i=="yz")l.makeBasis(e,n,o)}else{l.makeBasis(o,e,n)}var c=new r.Quaternion;c.setFromRotationMatrix(l);if(t!=null){var v=new r.Matrix4;v.getInverse(l);t.setFromRotationMatrix(v)}return c}function nr(e,t){switch(t.button){case 0:{Ue(e,function(e){if(N.children.length==0){var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices.push(e);var n=new r.Line(a,t);N.add(n)}else{var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices=N.children[0].geometry.vertices.slice(0);if(a.vertices.length<2){a.vertices.push(e)}else if(a.vertices.length==2){a.vertices.push(e);a.vertices.push(a.vertices[0])}else{a.vertices.pop();a.vertices.push(e);a.vertices.push(a.vertices[0])}var n=new r.Line(a,t);N.children=[];N.add(n);var o=a.vertices.length;if(o>3){var s=a.vertices[0];var l=a.vertices[1];var c=a.vertices[2];var v=new r.Vector3;var u=new r.Vector3;var f=new r.Vector3;v.subVectors(l,s).normalize();u.subVectors(c,s).normalize();f.crossVectors(v,u).normalize();var d=new r.Plane;d.setFromNormalAndCoplanarPoint(f,s);var p=new r.Quaternion;var h=ir(f,p,null,"z");var m=[];for(var y=0;y<a.vertices.length;y++){var w=new r.Vector3;w.copy(a.vertices[y]);w.sub(s);w.applyQuaternion(p);m.push(new r.Vector2(w.x,w.y))}var b=Math.abs(r.ShapeUtils.area(m));var g=b.toFixed(2)+" m²";a.computeBoundingBox();var x=a.boundingBox.getCenter();var k=new TextSprite({text:g,style:Ie.label});k.position.copy(x);vr();U.add(k);var M={area:b};i.onMeasure(M)}}var P=new r.Mesh(te,ae);P.position.copy(e);W.add(P)})}break;case 1:{if(N.children.length>0){var a=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var n=new r.Geometry;n.vertices=N.children[0].geometry.vertices.slice(0);if(n.vertices.length>4){n.vertices.pop();n.vertices.pop();n.vertices.push(n.vertices[0])}else if(n.vertices.length>3){n.vertices.pop();n.vertices.pop()}else{n.vertices.pop()}var o=new r.Line(n,a);N.children=[];N.add(o);W.children.pop();if(n.vertices.length>3){var s=n.vertices[0];var l=n.vertices[1];var c=n.vertices[2];var v=new r.Vector3;var u=new r.Vector3;var f=new r.Vector3;v.subVectors(l,s);v.normalize();u.subVectors(c,s);u.normalize();f.crossVectors(v,u);f.normalize();var d=new r.Plane;d.setFromNormalAndCoplanarPoint(f,s);var p=new r.Quaternion;var h=ir(f,p,null,"z");var m=[];for(var y=0;y<n.vertices.length;y++){var w=new r.Vector3;w.copy(n.vertices[y]);w.sub(s);w.applyQuaternion(p);m.push(new r.Vector2(w.x,w.y))}var b=new r.Shape(m);var g=new r.ShapeBufferGeometry(b);var a=new r.MeshBasicMaterial({color:65535,transparent:true,opacity:.5,side:r.DoubleSide});var x=new r.Mesh(g,a);x.position.copy(s);x.quaternion.copy(h);o.add(x);var k=Math.abs(r.ShapeUtils.area(m));var M=k.toFixed(2)+" m²";n.computeBoundingBox();var P=n.boundingBox.getCenter();var L=new TextSprite({text:M,style:Ie.label});L.position.copy(P);vr();U.add(L);var t={area:k};i.onMeasure(t)}else{vr()}}}break;case 2:{}break}}function or(e,t){switch(t.button){case 0:{Ue(e,function(e){if(N.children.length==0){var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices.push(e);var n=new r.Line(a,t);N.add(n);var o=new r.Mesh(te,ae);o.position.copy(e);W.add(o)}else{var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;var s=N.children[0].geometry.vertices[0];var l;var c;if(s.z>e.z){l=s;c=e}else{l=e;c=s}var v=new r.Vector3(l.x,l.y,c.z);a.vertices.push(l);a.vertices.push(c);a.vertices.push(v);a.vertices.push(l);var n=new r.Line(a,t);N.children=[];N.add(n);W.children=[];{var o=new r.Mesh(te,ae);o.position.copy(l);W.add(o)}{var o=new r.Mesh(te,ae);o.position.copy(c);W.add(o)}vr();var u={};{var f=l.distanceTo(c);var d=f.toFixed(2)+" m";u.length=f;var p=new TextSprite({text:d,style:Ie.label});p.position.copy(l);U.add(p)}{var f=c.distanceTo(v);var d=f.toFixed(2)+" m";u.lengthXY=f;var p=new TextSprite({text:d,style:Ie.label});var h=new r.Vector3;h.lerpVectors(c,v,.5);p.position.copy(h);U.add(p)}{var f=l.distanceTo(v);var d=f.toFixed(2)+" m";u.lengthZ=f;var p=new TextSprite({text:d,style:Ie.label});var h=new r.Vector3;h.lerpVectors(l,v,.5);p.position.copy(h);U.add(p)}i.onMeasure(u)}})}break;case 1:{if(N.children.length>0){N.children=[];W.children=[];vr()}}break;case 2:{}break}}function sr(e,t){switch(t.button){case 0:{Ue(e,function(e){if(N.children.length==0){var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices.push(e);var n=new r.Line(a,t);N.add(n);var o=new r.Mesh(te,ae);o.position.copy(e);W.add(o)}else{var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;var s=N.children[0].geometry.vertices[0];var l=e;var c=new r.Vector3(s.x,s.y,l.z);var v=new r.Vector3(l.x,l.y,s.z);a.vertices.push(s);a.vertices.push(c);a.vertices.push(l);a.vertices.push(v);a.vertices.push(s);var n=new r.Line(a,t);N.children=[];N.add(n);W.children=[];{var o=new r.Mesh(te,ae);o.position.copy(s);W.add(o)}{var o=new r.Mesh(te,ae);o.position.copy(l);W.add(o)}vr();var u={};{var f=s.distanceTo(c);var d=f.toFixed(2)+" m";u.height=f;var p=new TextSprite({text:d,style:Ie.label});var h=new r.Vector3;h.lerpVectors(s,c,.5);p.position.copy(h);U.add(p)}{var f=s.distanceTo(v);var d=f.toFixed(2)+" m";u.width=f;var p=new TextSprite({text:d,style:Ie.label});var h=new r.Vector3;h.lerpVectors(s,v,.5);p.position.copy(h);U.add(p)}{var m=s;var y=new r.Vector3;var w=new r.Vector3;var b=new r.Vector3;y.subVectors(v,s);y.normalize();w.subVectors(c,s);w.normalize();b.crossVectors(y,w);b.normalize();var g=new r.Plane;g.setFromNormalAndCoplanarPoint(b,s);var x=new r.Quaternion;var k=ir(b,x,null,"z");var M=[];for(var P=0;P<a.vertices.length;P++){var L=new r.Vector3;L.copy(a.vertices[P]);L.sub(m);L.applyQuaternion(x);M.push(new r.Vector2(L.x,L.y))}var T=new r.Shape(M);var S=new r.ShapeBufferGeometry(T);var t=new r.MeshBasicMaterial({color:65535,transparent:true,opacity:.5,side:r.DoubleSide});var z=new r.Mesh(S,t);z.position.copy(m);z.quaternion.copy(k);n.add(z);var V=Math.abs(r.ShapeUtils.area(M));var F=V.toFixed(2)+" m²";u.area=V;var p=new TextSprite({text:F,style:Ie.label});var h=new r.Vector3;h.lerpVectors(s,l,.5);p.position.copy(h);U.add(p)}i.onMeasure(u)}})}break;case 1:{if(N.children.length>0){N.children=[];W.children=[];vr()}}break;case 2:{}break}}function lr(e,t){switch(t.button){case 0:{Ue(e,function(e){if(N.children.length==0){var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices.push(e);var n=new r.Line(a,t);N.add(n)}else{var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;if(N.children[0].geometry.vertices.length==3)W.children=[];else a.vertices=N.children[0].geometry.vertices.slice(0);a.vertices.push(e);var n=new r.Line(a,t);N.children=[];N.add(n);if(a.vertices.length==3){var o=a.vertices[0];var s=a.vertices[1];var l=a.vertices[2];var c=new r.Vector3;var v=new r.Vector3;c.subVectors(o,s);v.subVectors(l,s);var u=c.angleTo(v)*180/Math.PI;var f=u.toFixed(2)+"°";var d=new TextSprite({text:f,style:Ie.label});a.computeBoundingBox();var p=a.boundingBox.getCenter();d.position.copy(p);vr();U.add(d);var h={angle:u};i.onMeasure(h)}else{vr()}}var m=new r.Mesh(te,ae);m.position.copy(e);W.add(m)})}break;case 1:{if(N.children.length>0){var a=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var n=new r.Geometry;n.vertices=N.children[0].geometry.vertices.slice(0);n.vertices.pop();var o=new r.Line(n,a);N.children=[];N.add(o);W.children.pop();vr()}}break;case 2:{}break}}function cr(e,t){switch(t.button){case 0:{Ue(e,function(e){if(N.children.length==0){var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;a.vertices.push(e);var n=new r.Line(a,t);N.add(n)}else{var t=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var a=new r.Geometry;if(N.children[0].geometry.vertices.length==4)W.children=[];else a.vertices=N.children[0].geometry.vertices.slice(0);if(a.vertices.length<2){a.vertices.push(e)}else if(a.vertices.length==2){a.vertices.push(e);a.vertices.push(a.vertices[0])}else{a.vertices.pop();a.vertices.push(e);a.vertices.push(a.vertices[0])}var n=new r.Line(a,t);N.children=[];N.add(n);if(a.vertices.length==4){var o=a.vertices[0];var s=a.vertices[1];var l=a.vertices[2];var c=new r.Vector3;var v=new r.Vector3;var u=new r.Vector3;c.subVectors(s,o);c.normalize();v.subVectors(l,o);v.normalize();u.crossVectors(c,v);u.normalize();var f=new r.Plane;f.setFromNormalAndCoplanarPoint(u,o);var d=new r.Quaternion;var p=ir(u,d,null,"z");var h=[];for(var m=0;m<a.vertices.length;m++){var y=new r.Vector3;y.copy(a.vertices[m]);y.sub(o);y.applyQuaternion(d);h.push(new r.Vector2(y.x,y.y))}var w=new r.Shape(h);var b=new r.ShapeBufferGeometry(w);var t=new r.MeshBasicMaterial({color:65535,transparent:true,opacity:.5,side:r.DoubleSide});var g=new r.Mesh(b,t);g.position.copy(o);g.quaternion.copy(p);n.add(g);var x=new r.Vector3(0,0,1);var k=u.angleTo(x)*180/Math.PI;var M=k.toFixed(2)+"°";var P=new TextSprite({text:M,style:Ie.label});a.computeBoundingBox();var L=a.boundingBox.getCenter();P.position.copy(L);vr();U.add(P);var T={slope:k};i.onMeasure(T)}else{vr()}}var S=new r.Mesh(te,ae);S.position.copy(e);W.add(S)})}break;case 1:{if(N.children.length>0){var a=new r.LineBasicMaterial({color:16711935,opacity:1,linewidth:3});var n=new r.Geometry;n.vertices=N.children[0].geometry.vertices.slice(0);if(n.vertices.length>4){n.vertices.pop();n.vertices.pop();n.vertices.push(n.vertices[0])}else if(n.vertices.length>3){n.vertices.pop();n.vertices.pop()}else{n.vertices.pop()}var o=new r.Line(n,a);N.children=[];N.add(o);W.children.pop();vr()}}break;case 2:{}break}}function vr(){U.children=[]}function ur(){N.children=[];j.children=[];W.children=[];R.children=[];vr();if(Fe){Xe(Fe)}Fe=null;Zr()}function fr(e,t,a,i,n,o,s,l){var c=new r.MeshBasicMaterial({color:16777215,transparent:true,alphaTest:.1,side:r.DoubleSide,shading:r.SmoothShading});if(n==null){c.map=new r.Texture}else if(n instanceof String){c.map=I.load(n)}else if(n instanceof r.Texture){c.map=n}ve(c.map);if(i!=null){c.color.setHex(i)}var v=new r.Mesh(t,c);v.currentHex=c.color.getHex();if(a!=null)v.name=a;if(s!=null)v.rotation.copy(s);if(l!=null)v.scale.copy(l);if(o!=null)v.position.copy(o);e.add(v);return v}function dr(e,t,a){var i=I.load(a);i.minFilter=r.LinearFilter;i.magFilter=r.LinearFilter;i.generateMipmaps=false;i.mapping=r.UVMapping;var n=new r.MeshBasicMaterial({color:16777215,map:i});n.transparent=true;var o=new r.Mesh(t,n);e.add(o);return o}function pr(e){ur();u=e;console.debug("cur_tool: %d",u);var r={tool:e};i.onTool(r)}function hr(e){e.stopPropagation();pr(Tool.measurePoint)}function mr(e){e.stopPropagation();pr(Tool.measureLength)}function yr(e){e.stopPropagation();pr(Tool.measureArea)}function wr(e){e.stopPropagation();pr(Tool.measureZ)}function br(e){e.stopPropagation();pr(Tool.measureFacade)}function gr(e){e.stopPropagation();pr(Tool.measureAngle)}function xr(e){e.stopPropagation();pr(Tool.measureSlope)}function kr(e){e.stopPropagation();pr(Tool.createPoint)}function Mr(e){e.stopPropagation();pr(Tool.createPolyline)}function Pr(e){e.stopPropagation();pr(Tool.createPolygon)}function Lr(e){e.stopPropagation();pr(Tool.pick)}function Tr(e){e.stopPropagation();pr(Tool.remove)}function Sr(e){e.stopPropagation()}function zr(){var e=document.createElement("div");e.setAttribute("class","ppv_toolbar");o.appendChild(e);var r=document.createElement("img");r.setAttribute("src","icon/查询坐标.png");r.setAttribute("title","查询坐标");r.setAttribute("class","ppv_button");r.addEventListener("mousedown",hr,false);e.appendChild(r);var t=document.createElement("img");t.setAttribute("src","icon/测量长度.png");t.setAttribute("title","测量长度");t.setAttribute("class","ppv_button");t.addEventListener("mousedown",mr,false);e.appendChild(t);var a=document.createElement("img");a.setAttribute("src","icon/测量面积.png");a.setAttribute("title","测量面积");a.setAttribute("class","ppv_button");a.addEventListener("mousedown",yr,false);e.appendChild(a);var i=document.createElement("img");i.setAttribute("src","icon/测量垂距.png");i.setAttribute("title","测量垂距");i.setAttribute("class","ppv_button");i.addEventListener("mousedown",wr,false);e.appendChild(i);var n=document.createElement("img");n.setAttribute("src","icon/测量立面.png");n.setAttribute("title","测量立面");n.setAttribute("class","ppv_button");n.addEventListener("mousedown",br,false);e.appendChild(n);var s=document.createElement("img");s.setAttribute("src","icon/测量角度.png");s.setAttribute("title","测量角度");s.setAttribute("class","ppv_button");s.addEventListener("mousedown",yr,false);e.appendChild(s);var l=document.createElement("img");l.setAttribute("src","icon/测量坡度.png");l.setAttribute("title","测量坡度");l.setAttribute("class","ppv_button");l.addEventListener("mousedown",xr,false);e.appendChild(l);var c=document.createElement("img");c.setAttribute("src","icon/创建点.png");c.setAttribute("title","创建点");c.setAttribute("class","ppv_button");c.addEventListener("mousedown",kr,false);e.appendChild(c);var v=document.createElement("img");v.setAttribute("src","icon/创建线.png");v.setAttribute("title","创建线");v.setAttribute("class","ppv_button");v.addEventListener("mousedown",Mr,false);e.appendChild(v);var u=document.createElement("img");u.setAttribute("src","icon/创建面.png");u.setAttribute("title","创建面");u.setAttribute("class","ppv_button");u.addEventListener("mousedown",Pr,false);e.appendChild(u);var f=document.createElement("img");f.setAttribute("src","icon/选择对象.png");f.setAttribute("title","选择对象");f.setAttribute("class","ppv_button");f.addEventListener("mousedown",Lr,false);e.appendChild(f);var d=document.createElement("img");d.setAttribute("src","icon/删除选中对象.png");d.setAttribute("title","删除选中对象");d.setAttribute("class","ppv_button");d.addEventListener("mousedown",Tr,false);e.appendChild(d);var p=document.createElement("img");p.setAttribute("src","icon/LRS.png");p.setAttribute("title","线性参考系");p.setAttribute("class","ppv_button");p.addEventListener("mousedown",Sr,false);e.appendChild(p)}function Vr(){I.crossOrigin="anonymous";B=new r.Scene;C=new r.PerspectiveCamera(45,1,.1,1e4);E=new r.PerspectiveCamera(45,1,.1,1e4);E.visible=false;C.position.set(0,0,0);var t=C.position;C.up.set(0,1,0);C.lookAt(new r.Vector3(t.x+0,t.y+1,t.z+0));B.add(C);control=new RotControl(C,o);control.onRot=function(e){Kr();i.onEye(e);if(m!=null){var r=C.getWorldDirection();var t=Math.atan2(r.x,r.y);var a=0;switch(c){case-1:a=-m.cur.heading;break;case 0:a=-m.Currentframe.Heading;break;case 3:a=m.Currentframe.Yaw*Math.PI/180;break;case 4:a=m.Currentframe.Heading*Math.PI/180;break}y=a-t}};var a=[];a[0]=new r.DirectionalLight(16777215,.8);a[1]=new r.DirectionalLight(16777215,.8);a[2]=new r.DirectionalLight(16777215,.8);a[3]=new r.AmbientLight(16777215,.8);a[4]=new r.PointLight(16777215,.8);a[0].position.set(-1,1,1);a[1].position.set(0,1,1);a[2].position.set(0,-1,1);C.add(a[0]);C.add(a[1]);B.add(a[3]);B.add(H);B.add(G);G.add(q);B.add(D);D.add(_);D.add(O);D.add(N);D.add(j);D.add(W);D.add(R);D.add(U);D.add(Y);g=Ie.scope/M;var t=new r.Vector3(0,M*g,0);var s=new r.Euler(Math.PI/2,0,0);var l=new r.Vector3(x*g,k*g,1);$=fr(K,re,"camgroup",16777215,null,t,s,l);H.add(K);ee=new r.Mesh(ie,ne);ne.map=new r.Texture;ee.scale.set(-Ie.scope,Ie.scope,Ie.scope);var v=new r.Vector3(0,-1,0);ee.up.set(0,0,1);ee.lookAt(v);A=new r.WebGLRenderer({alpha:true,antialias:true});A.setClearColor(Ie.bgcolor,0);A.setPixelRatio(window.devicePixelRatio);o.appendChild(A.domElement);n.bind("contextmenu",Or);n.bind("touchstart",Nr);n.bind("mousedown",Ur);n.bind("mouseup",Yr);n.bind("mousemove",qr);n.bind("mousewheel",Qr);e(window).bind("keydown",_r);if(window.DeviceOrientationEvent){window.addEventListener("deviceorientationabsolute",Ir,false)}Cr()}function Fr(e,t,a){var i=Math.PI/180;var n=180/Math.PI;var o=t?t*i:0;var s=a?a*i:0;var l=e?e*i:0;var c=Math.cos(o/2);var v=Math.cos(s/2);var u=Math.cos(l/2);var f=Math.sin(o/2);var d=Math.sin(s/2);var p=Math.sin(l/2);var h=c*v*u-f*d*p;var m=f*v*u-c*d*p;var y=c*d*u+f*v*p;var w=c*v*p+f*d*u;var b=new r.Quaternion(m,y,w,h);return b}function Ir(e){if(!Ie.enableDeviceOrientation)return;if(!Br())return;var t=new r.Vector3(0,0,-1);var a=new r.Vector3(0,0,1);var i=Fr(e.alpha,e.beta,e.gamma);t.applyQuaternion(i);var n=C.position;var o=new r.Vector3;o.addVectors(n,t);C.up.copy(a);C.lookAt(o);var t=C.getWorldDirection();var s=Math.atan2(t.x,t.y)*180/Math.PI;var l=Math.asin(t.z)*180/Math.PI;var c=C.fov;var v=Math.atan(Math.tan(c/2)*C.aspect)*2*180/Math.PI;var u={heading:s,pitch:l,fovx:v,dir:t};control.onRot(u)}function Cr(){requestAnimationFrame(Cr);Er()}function Er(){Ar();{var e=C.position.distanceTo(ce.getWorldPosition());var t=Re(1,C.fov*Math.PI/180,e,A.domElement.clientHeight);var a=ce.style.fontsize/t;ce.scale.set(a,a,a)}for(var n=0;n<U.children.length;n++){var o=U.children[n];{var e=C.position.distanceTo(o.getWorldPosition());var t=Re(1,C.fov*Math.PI/180,e,A.domElement.clientHeight);var a=o.style.fontsize/t;o.scale.set(a,a,a)}}for(var n=0;n<W.children.length;n++){var o=W.children[n];var e=C.position.distanceTo(o.getWorldPosition());var t=Re(1,C.fov*Math.PI/180,e,A.domElement.clientHeight);var a=5/t;o.scale.set(a,a,a)}for(var n=0;n<q.children.length;n++){var s=q.children[n];var l=s.userData;if(l.fixSize)continue;for(var c=0;c<s.children.length;c++){var v=s.children[c];v.visible=true;for(var u=0;u<v.children.length;u++){var o=v.children[u];if(o instanceof TextSprite){var e=C.position.distanceTo(o.getWorldPosition());var t=Re(1,C.fov*Math.PI/180,e,A.domElement.clientHeight);var a=l.fontSize/t;o.scale.set(a,a,a)}else if(o instanceof r.Sprite){var e=C.position.distanceTo(o.getWorldPosition());if(e>Ie.scope){v.visible=false;break}var t=Re(1,C.fov*Math.PI/180,e,A.domElement.clientHeight);var a=l.size/t;o.scale.set(a,a,a)}}}}if(p){_.visible=false;O.visible=false}else{_.visible=Ie.enableArrow;O.visible=Ie.enableHistory}var f=A.getSize();var d=A.userData;A.setViewport(0,0,f.width,f.height);A.setScissor(d.left,d.top,d.width,d.height);A.setScissorTest(true);A.render(B,C);var h={canvas:A.domElement};i.onRender(h);if(E.visible){W.visibleTemp=W.visible;N.visibleTemp=N.visible;_.visibleTemp=_.visible;O.visibleTemp=O.visible;Y.visibleTemp=Y.visible;W.visible=false;N.visible=false;_.visible=false;O.visible=false;Y.visible=false;var m=Ie.magnifier.size/2;if(Ie.magnifier.fix){A.setViewport(Se.x-m,Se.y-m,Ie.magnifier.size,Ie.magnifier.size);A.setScissor(Se.x-m,Se.y-m,Ie.magnifier.size,Ie.magnifier.size)}else{A.setViewport(Te.x-m,Te.y-m,Ie.magnifier.size,Ie.magnifier.size);A.setScissor(Te.x-m,Te.y-m,Ie.magnifier.size,Ie.magnifier.size)}A.setScissorTest(true);A.render(B,E);W.visible=W.visibleTemp;N.visible=N.visibleTemp;_.visible=_.visibleTemp;O.visible=O.visibleTemp;Y.visible=Y.visibleTemp}}function Br(){if(K.children.length>0&&K.children[0]==ee)return true;else return false}function Ar(){var e=Hr();var r=o.clientWidth;var t=o.clientHeight;var a=r/t;var i={top:0,left:0,width:r,height:t};A.userData=i;C.aspect=a;if(Br()){}else{var n=k;switch(Ie.fullView){case FullMode.fill:{if(a>P){}else{n=x/a}C.aspect=a}break;case FullMode.trans:{if(a>P){i.left=(r-t*P)/2;i.width=t*P}else{i.top=(t-r/P)/2;i.height=r/P;n=x/a}}break;case FullMode.clip:{if(a>P){n=x/a}}break;case FullMode.stretch:{C.aspect=P}break}var s=2*Math.atan(n/2/M)*180/Math.PI;C.fov=s}C.updateProjectionMatrix();if(E.visible){E.fov=C.fov*Ie.magnifier.size/t/Ie.magnifier.zoom;E.updateProjectionMatrix()}A.setSize(r,t)}function Gr(e){if(e.requestFullscreen){e.requestFullscreen()}else if(e.mozRequestFullScreen){e.mozRequestFullScreen()}else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen()}else if(e.msRequestFullscreen){e.msRequestFullscreen()}}function Dr(){if(document.exitFullscreen){document.exitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}}function Hr(){var e=document.mozFullScreen;var r=document.webkitIsFullScreen;var t=document.fullscreen;var a=document.msFullscreen;return e||r||t||a}function _r(e){switch(e.keyCode){case 27:{pr(Tool.none)}break;case Ie.key.del:if(Fe){var r=Fe;var e={layer:r.parent,feature:r,layername:r.parent.name,fid:r.userData.fid};i.onFeatureRemove(e);if(e.cancel)return;i.removeFeature(r);Fe=null}break;case Ie.key.play:{if(d)i.stop();else i.play()}break;case Ie.key.fforward:{i.step(10)}break;case Ie.key.fbackward:{i.step(-10)}break;case Ie.key.forward:{i.step(1)}break;case Ie.key.backward:{i.step(-1)}break;case Ie.key.fullscreen:{if(Hr())Dr();else Gr(o)}break}}function Or(e){e.preventDefault()}function Nr(e){e.preventDefault();if(e.originalEvent.touches.length==1){e=e.originalEvent.touches[0];We(e);{Ne(e);control.enabled=Br();jr=true;Wr=false;Rr.x=e.offsetX;Rr.y=e.offsetY}{Wr=false;if(!jr)return;Pe.setFromCamera(Le,C);var r=Pe.intersectObject(_,true);if(r.length>0){if(r[0].object.name=="history"){Xr(r[0].object.userData)}else{var t=r[0].object.name;Ce(t)}}else{console.debug("onPPVisionMouseUp cur_tool: %d",u);switch(u){case Tool.none:Jr(Le,e);break;case Tool.measurePoint:tr(Le,e);break;case Tool.measureLength:ar(Le,e);break;case Tool.measureArea:nr(Le,e);break;case Tool.measureZ:or(Le,e);break;case Tool.measureFacade:sr(Le,e);break;case Tool.measureAngle:lr(Le,e);break;case Tool.measureSlope:cr(Le,e);break;case Tool.createPoint:$e(Le,e);break;case Tool.createPolyline:er(Le,e);break;case Tool.createPolygon:rr(Le,e);break;case Tool.pick:Ze(Le,e);break;case Tool.remove:Ke(Le,e);break}}}}}var jr=false;var Wr=false;var Rr={x:0,y:0};function Ur(e){e.preventDefault();Ne(e);control.enabled=Br();jr=true;Wr=false;Rr.x=e.offsetX;Rr.y=e.offsetY}function Yr(e){e.preventDefault();Ne(e);Wr=false;if(!jr)return;Pe.setFromCamera(Le,C);var r=Pe.intersectObject(_,true);if(r.length>0){if(r[0].object.name=="history"){Xr(r[0].object.userData)}else{var t=r[0].object.name;Ce(t)}}else{console.debug("onPPVisionMouseUp cur_tool: %d",u);switch(u){case Tool.none:Jr(Le,e);break;case Tool.measurePoint:tr(Le,e);break;case Tool.measureLength:ar(Le,e);break;case Tool.measureArea:nr(Le,e);break;case Tool.measureZ:or(Le,e);break;case Tool.measureFacade:sr(Le,e);break;case Tool.measureAngle:lr(Le,e);break;case Tool.measureSlope:cr(Le,e);break;case Tool.createPoint:$e(Le,e);break;case Tool.createPolyline:er(Le,e);break;case Tool.createPolygon:rr(Le,e);break;case Tool.pick:Ze(Le,e);break;case Tool.remove:Ke(Le,e);break}}}function qr(e){e.preventDefault();Ne(e);if(e.buttons>0){if(!Wr){var r=e.offsetX-Rr.x;var t=e.offsetY-Rr.y;if(Math.abs(r)>3||Math.abs(t)>3){Wr=true;jr=false}}}Y.visible=false;Te.x=e.offsetX;Te.y=o.clientHeight-e.offsetY;if(e.ctrlKey){if(!E.visible){E.visible=true;Se.copy(Te);if(Ie.magnifier.fix){Pe.setFromCamera(Le,C);var a=Pe.ray;E.position.set(0,0,0);E.up.copy(C.up);E.lookAt(a.direction);E.position.copy(C.position)}}if(Ie.magnifier.fix){ze=Oe(Te)}else{ze.set(0,0);var i=Oe(Te);Pe.setFromCamera(i,C);var a=Pe.ray;E.position.set(0,0,0);E.up.copy(C.up);E.lookAt(a.direction);E.position.copy(C.position)}return}else{E.visible=false}Pe.setFromCamera(Le,C);var n=Pe.intersectObject(_,true);if(n.length>0){if(Ve!=n[0].object){if(Ve)Ve.material.color.setHex(Ve.currentHex);Ve=n[0].object;Ve.currentHex=Ve.material.color.getHex();Ve.material.color.setHex(16711680)}return}else{if(Ve)Ve.material.color.setHex(Ve.currentHex);Ve=null}if(Ie.enableSurfaceDetection&&u==Tool.none){Y.visible=false;Qe(Le,function(e){var r=e.distanceTo(C.position);var t=r;if(t>5&&t<100){Y.visible=true;Y.position.copy(e);if(r>0)ce.setText("前进 "+t.toFixed(0)+"m");else ce.setText("后退 "+t.toFixed(0)+"m")}else{Y.visible=false}})}}function Qr(e){e.preventDefault();if(Br()){if(e.deltaY>0&&C.fov>5){C.fov*=.8;C.updateProjectionMatrix()}else if(e.deltaY<0&&C.fov<90){C.fov*=1.2;C.updateProjectionMatrix()}}else{if(e.deltaY>0){i.step(1)}else{i.step(-1)}}}function Jr(e,r){if(!Y.visible)return;var t=[Y.position.x+X.x,Y.position.y+X.y,Y.position.z+X.z];var a=J.inverse(t);i.locate(c,a[0],a[1],s)}function Xr(e){var r=Zr();if(r==null)return;var t=document.createElement("div");r.appendChild(t);t.id="history";t.className="history";for(var a=0;a<e.length;a++){var i=e[a];var n=document.createElement("img");n.id="history_item_"+a;n.className="history_item";n.setAttribute("src",i.thumb);n.setAttribute("title",i.date);n.userData=i;n.thumbError=false;n.addEventListener("error",function(){if(!this.thumbError){this.thumbError=true;this.src=this.userData.img}else{this.src=xe}},false);n.addEventListener("click",function(){Ce(this.userData.id)},false);t.appendChild(n)}}function Zr(){var e=document.getElementById("history_container");if(e!=null){var r=document.getElementById("history");if(r!=null){e.removeChild(r)}}return e}function Kr(){var e=C.position;var t=C.getWorldDirection();var a=new r.Vector3(0,0,1);var i=new r.Vector3;i.crossVectors(t,a);i.normalize();t.setLength(Ie.arrows.forward);_.position.set(0,0,-Ie.arrows.below);_.position.add(e);_.position.add(t);_.quaternion.setFromAxisAngle(i,Math.PI/Ie.arrows.lean)}function $r(e,a){var n=e.cur;var o;if(a){ur();var s="+proj=tmerc +lat_0="+n.lat+" +lon_0="+n.lon+" +k=1.000000 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs ";J=t(s);o=J.forward([n.lon,n.lat]);X.x=o[0];X.y=o[1];X.z=n.alt;i.needsUpdate=true}else{o=J.forward([n.lon,n.lat])}Z.set(o[0],o[1],n.alt);Z.sub(X);var l=new r.Euler(n.pitch,n.roll,n.yaw,"ZXY");K.position.copy(Z);K.rotation.copy(l);if(Br()){var c=C.getWorldDirection();var v=Math.atan2(c.x,c.y);var u=-n.heading;var f=u-v;if(y!=null){var m=y-f;var w=new r.Euler(0,0,m);var b=new r.Quaternion;b.setFromEuler(w);C.quaternion.premultiply(b)}}else{var g=new r.Vector3(0,1,0);var x=new r.Vector3(0,0,1);g.applyEuler(l);x.applyEuler(l);C.position.set(0,0,0);C.up.copy(x);C.lookAt(g)}C.position.copy(Z);Kr();_.children=[];var k={lon:n.lon,lat:n.lat,alt:n.alt};if(e.history!=null&&e.history.length>0){if(e.next==null){e.next=e.history.shift()}else if(e.prev==null){e.prev=e.history.shift()}}var M=.01;var P=new r.Vector3(0,1,0);var L=e.next;if(L!=null){var g=J.forward([L.lon,L.lat]);var c=new r.Vector3(g[0]-o[0],g[1]-o[1],0).normalize();var T=Math.atan2(c.x,c.y);var u=T*180/Math.PI;var S=new r.Group;_.add(S);S.rotation.set(0,0,-T);var z=fr(S,re,L.id,16772846,ge(u));z.position.copy(P);P.z+=.01;k.next={id:L.id,heading:u}}var L=e.prev;if(L!=null){var g=J.forward([L.lon,L.lat]);var c=new r.Vector3(g[0]-o[0],g[1]-o[1],0).normalize();var T=Math.atan2(c.x,c.y);var u=T*180/Math.PI;var S=new r.Group;_.add(S);S.rotation.set(0,0,-T);var z=fr(S,re,L.id,15663086,ge(u));z.position.copy(P);P.z+=.01;k.prev={id:L.id,heading:u}}if(e.branch!=null){k.branch=[];for(var V=0;V<e.branch.length;V++){var L=e.branch[V];if(L!=null){var T=-L.heading;var u=T*180/Math.PI;var I=Math.abs(n.heading-L.heading)*180/Math.PI;while(I>360){I-=360}if(I>150){k.back={id:L.id,heading:u};continue}var S=new r.Group;_.add(S);S.rotation.set(0,0,-T);var z=fr(S,re,L.id,15658751,ge(u));z.position.copy(P);P.z+=.01;k.branch.push({id:L.id,heading:u})}}}var E=false;if(e.history!=null){if(e.history.length>0){var z=fr(_,re,"history",16777215,be);z.scale.set(.7,.7,.7);z.userData=[];k.history=[];for(var V=0;V<e.history.length;V++){var L=e.history[V];if(L!=null){var B=F+"train/"+L.train+"/images/"+Ie.thumb+"/"+L.image;var A=F+"train/"+L.train+"/images/"+L.image;var G={id:L.id,date:L.train,thumb:B,img:A};z.userData.push(G);var D={id:L.id,date:L.train};k.history.push(D)}}}}i.onPosition(k);if(i.needsUpdate){i.needsUpdate=false;for(var V=0;V<q.children.length;V++){var H=q.children[V];i.setLayer(H,H.userData)}}{var c=C.getWorldDirection();var u=Math.atan2(c.x,c.y)*180/Math.PI;var O=Math.asin(c.z)*180/Math.PI;var N=C.fov;var j=Math.atan(Math.tan(N/2)*C.aspect)*2*180/Math.PI;var W={heading:u,pitch:O,fovx:j,dir:c};i.onEye(W)}h=n.id;var R={state:LocateState.success};i.onLocate(R);p=false;if(d){Ce(Ee(1))}}function et(r,t){m=null;if(r==""){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}var n=e.parseJSON(r);if(n==null){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}var o=n.Currentframe;if(o==null){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}m=n;var s=o.Imgurl;var l=s.lastIndexOf("/");var c=s.substr(0,l)+"/"+Ie.thumb+s.substr(l);at(c,s,rt,n,t)}function rt(e,a){var n=e.Currentframe;var o;if(a){ur();var s="+proj=tmerc +lat_0="+n.Lat+" +lon_0="+n.Lon+" +k=1.000000 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs ";J=t(s);o=J.forward([n.Lon,n.Lat]);X.x=o[0];X.y=o[1];X.z=n.Alt;i.needsUpdate=true}else{o=J.forward([n.Lon,n.Lat])}Z.set(o[0],o[1],n.Alt);Z.sub(X);var l=new r.Euler(n.Pitch,n.Roll,n.Yaw,"ZXY");K.position.copy(Z);K.rotation.copy(l);if(Br()){var c=C.getWorldDirection();var v=Math.atan2(c.x,c.y);var u=-n.Heading;var f=u-v;if(y!=null){var m=y-f;var w=new r.Euler(0,0,m);var b=new r.Quaternion;b.setFromEuler(w);C.quaternion.premultiply(b)}}else{var g=new r.Vector3(0,1,0);var x=new r.Vector3(0,0,1);g.applyEuler(l);x.applyEuler(l);C.position.set(0,0,0);C.up.copy(x);C.lookAt(g)}C.position.copy(Z);Kr();_.children=[];var k={lon:n.Lon,lat:n.Lat,alt:n.Alt};if(e.Historyframe!=null&&e.Historyframe.length>0){if(e.next==null){e.next=e.Historyframe.shift()}else if(e.prev==null){e.prev=e.Historyframe.shift()}}var M=.01;var P=new r.Vector3(0,1,0);var L=e.Nextframe;if(L!=null){var g=J.forward([L.Lon,L.Lat]);var c=new r.Vector3(g[0]-o[0],g[1]-o[1],0).normalize();var T=Math.atan2(c.x,c.y);var u=T*180/Math.PI;var S=new r.Group;_.add(S);S.rotation.set(0,0,-T);var z=fr(S,re,L.ImgId,16772846,ge(u));z.position.copy(P);P.z+=.01;k.next={id:L.ImgId,heading:u}}var L=e.Prevframe;if(L!=null){var g=J.forward([L.Lon,L.Lat]);var c=new r.Vector3(g[0]-o[0],g[1]-o[1],0).normalize();var T=Math.atan2(c.x,c.y);var u=T*180/Math.PI;var S=new r.Group;_.add(S);S.rotation.set(0,0,-T);var z=fr(S,re,L.ImgId,15663086,ge(u));z.position.copy(P);P.z+=.01;k.prev={id:L.ImgId,heading:u}}if(e.Branchframe!=null){k.branch=[];for(var V=0;V<e.Branchframe.length;V++){var L=e.Branchframe[V];if(L!=null){var T=-L.Heading;var u=T*180/Math.PI;var F=Math.abs(n.Heading-L.Heading)*180/Math.PI;while(F>360){F-=360}if(F>150){k.back={id:L.ImgId,heading:u};continue}var S=new r.Group;_.add(S);S.rotation.set(0,0,-T);var z=fr(S,re,L.ImgId,15658751,ge(u));z.position.copy(P);P.z+=.01;k.branch.push({id:L.ImgId,heading:u})}}}var I=false;if(e.Historyframe!=null){if(e.Historyframe.length>0){var z=fr(_,re,"history",16777215,be);z.scale.set(.7,.7,.7);z.userData=[];k.history=[];for(var V=0;V<e.Historyframe.length;V++){var L=e.Historyframe[V];if(L!=null){var E=n.Imgurl;var g=E.lastIndexOf("/");var B=E.substr(0,g)+"/"+Ie.thumb+E.substr(g);var A={id:L.ImgId,date:L.Train,thumb:B,img:E};z.userData.push(A);var G={id:L.ImgId,date:L.Train};k.history.push(G)}}}}i.onPosition(k);if(i.needsUpdate){i.needsUpdate=false;for(var V=0;V<q.children.length;V++){var D=q.children[V];i.setLayer(D,D.userData)}}{var c=C.getWorldDirection();var u=Math.atan2(c.x,c.y)*180/Math.PI;var H=Math.asin(c.z)*180/Math.PI;var O=C.fov;var N=Math.atan(Math.tan(O/2)*C.aspect)*2*180/Math.PI;var j={heading:u,pitch:H,fovx:N,dir:c};i.onEye(j)}h=n.ImgId;var W={state:LocateState.success};i.onLocate(W);p=false;if(d){Ce(Ee(1))}}function tt(t){z=null;if(S!=null&&S.length>0){if(t!=null){for(var a=0;a<S.length;a++){var i=S[a];var n=i.EquipId;var o=t.indexOf(n);if(o>=0){if(i.Width>0)x=i.Width;if(i.Height>0)k=i.Height;if(i.Focalx>0)M=i.Focalx;P=x/k;if(i.Principalx>0)L=i.Principalx;if(i.Principaly>0)T=i.Principaly;if(i.Ext!=null){var s=e.parseJSON(i.Ext);if(s.twins!=null&&s.twins!=0){z=s.twins*Math.PI/180}}g=Ie.scope/M;var o=new r.Vector3(0,M*g,0);var l=new r.Euler(Math.PI/2,0,0);var c=new r.Vector3(x*g,k*g,1);$.rotation.copy(l);$.scale.copy(c);$.position.copy(o);break}}}}}function at(e,r,t,a,n){if(m!=null){switch(c){case-1:v=m.cur.type;break;case 0:v=m.Currentframe.Type;tt(m.Currentframe.Train);break;case 3:v=2;tt(m.Currentframe.Pictureurl);break;case 4:v=1;break}}var o=$.material.map;if(v==1){o=ee.material.map;K.children=[];K.add(ee)}else{K.children=[];K.add($)}I.load(e,function(e){o.image=e.image;o.needsUpdate=true;t(a,n);if(d)return;p=true;I.load(r,function(e){o.image=e.image;o.needsUpdate=true;p=false},null,function(){p=false})},null,function(){I.load(r,function(e){o.image=e.image;o.needsUpdate=true;t(a,n)},null,function(){var e={state:LocateState.imageError};i.onLocate(e);if(v==1){o.image=Me.image;o.needsUpdate=true}else{o.image=ke.image;o.needsUpdate=true}t(a,n)})})}function it(r,t){m=null;if(r==""){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}var n=e.parseJSON(r);if(n==null){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}var o=n.cur;if(o==null){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}m=n;var s=F+"train/"+o.train+"/images/"+Ie.thumb+"/"+o.image;var l=F+"train/"+o.train+"/images/"+o.image;at(s,l,$r,n,t)}function nt(r,t){m=null;if(r==""){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}var n=e.parseJSON(r);if(n==null){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}var o=n.Currentframe;if(o==null){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}m=n;var s=o.Pictureurl;var l=s.lastIndexOf("/");var c=s.substr(0,l)+"/"+Ie.thumb+s.substr(l);at(c,s,st,n,t)}function ot(r,t){m=null;if(r==""){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}var n=e.parseJSON(r);if(n==null){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}var o=n.Currentframe;if(o==null){var a={state:LocateState.dataError};i.onLocate(a);console.warn(r);p=false;return}m=n;var s=o.Pictureurl;var l=s.lastIndexOf("/");var c=s.substr(0,l)+"/"+Ie.thumb+s.substr(l);at(c,s,lt,n,t)}function st(e,a){var n=e.Currentframe;var o;if(a){ur();var s="+proj=tmerc +lat_0="+n.Latitude+" +lon_0="+n.Longitude+" +k=1.000000 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs ";J=t(s);o=J.forward([n.Longitude,n.Latitude]);X.x=o[0];X.y=o[1];X.z=n.Altitude;i.needsUpdate=true}else{o=J.forward([n.Longitude,n.Latitude])}Z.set(o[0],o[1],n.Altitude);Z.sub(X);var l=new r.Euler(-n.Pitch*Math.PI/180,n.Roll*Math.PI/180,n.Yaw*Math.PI/180,"ZXY");if(z!=null){l.z+=z}var c=new r.Vector3(0,M,0);var v=new r.Vector3(0,0,1);c.applyEuler(l);v.applyEuler(l);if(!Br()){C.position.set(0,0,0);C.up.set(v.x,v.y,v.z);C.lookAt(c)}C.position.copy(Z);K.position.copy(Z);K.rotation.copy(l);Kr();_.children=[];var u={lon:n.Longitude,lat:n.Latitude,alt:n.Altitude};if(e.Historyframe!=null&&e.Historyframe.length>0){if(e.Nextframe==null){e.Nextframe=e.Historyframe.shift()}else if(e.Prevframe==null){e.Prevframe=e.Historyframe.shift()}}var f=new r.Vector3(0,1,0);var m=e.Nextframe;if(m!=null){var c=J.forward([m.Longitude,m.Latitude]);var y=new r.Vector3(c[0]-o[0],c[1]-o[1],0).normalize();var w=Math.atan2(y.x,y.y);var b=w*180/Math.PI;var g=new r.Group;_.add(g);g.rotation.set(0,0,-w);var x=fr(g,re,m.PmId,16772846,ge(b));x.position.copy(f);f.z+=.01;u.next={id:m.PmId,heading:b}}var m=e.Prevframe;if(m!=null){var c=J.forward([m.Longitude,m.Latitude]);var y=new r.Vector3(c[0]-o[0],c[1]-o[1],0).normalize();var w=Math.atan2(y.x,y.y);var b=w*180/Math.PI;var g=new r.Group;_.add(g);g.rotation.set(0,0,-w);var x=fr(g,re,m.PmId,15663086,ge(b));x.position.copy(f);f.z+=.01;u.prev={id:m.PmId,heading:b}}var k;if(e.Branchframe!=null){u.branch=[];for(var P=0;P<e.Branchframe.length;P++){var m=e.Branchframe[P];if(m!=null){var b=-m.Yaw;var w=b*Math.PI/180;var L=Math.abs(n.Yaw-m.Yaw);while(L>360){L-=360}if(L>150){u.back={id:m.PmId,heading:b};continue}var g=new r.Group;_.add(g);g.rotation.set(0,0,-w);var x=fr(g,re,m.PmId,15658751,ge(b));x.position.copy(f);f.z+=.01;u.branch.push({id:m.PmId,heading:b})}}}var T=false;if(e.Historyframe!=null){if(e.Historyframe.length>0){var x=fr(_,re,"history",16777215,be);x.scale.set(.7,.7,.7);x.userData=[];u.history=[];for(var P=0;P<e.Historyframe.length;P++){var m=e.Historyframe[P];if(m!=null){var S=n.Pictureurl;var c=S.lastIndexOf("/");var V=S.substr(0,c)+"/"+Ie.thumb+S.substr(c);var F={id:m.PmId,date:m.Importtime,thumb:V,img:S};x.userData.push(F);var I={id:m.PmId,date:m.Importtime};u.history.push(I)}}}}i.onPosition(u);if(i.needsUpdate){i.needsUpdate=false;for(var P=0;P<q.children.length;P++){var E=q.children[P];i.setLayer(E,E.userData)}}{var y=C.getWorldDirection();var b=Math.atan2(y.x,y.y)*180/Math.PI;var B=Math.asin(y.z)*180/Math.PI;var A=C.fov;var G=Math.atan(Math.tan(A/2)*C.aspect)*2*180/Math.PI;var D={heading:b,pitch:B,fovx:G,dir:y};i.onEye(D)}h=n.PmId;var H={state:LocateState.success};i.onLocate(H);p=false;if(d){Ce(Ee(1))}}function lt(e,a){var n=e.Currentframe;var o;if(a){ur();var s="+proj=tmerc +lat_0="+n.Latitude+" +lon_0="+n.Longitude+" +k=1.000000 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs ";J=t(s);o=J.forward([n.Longitude,n.Latitude]);X.x=o[0];X.y=o[1];X.z=n.Height;i.needsUpdate=true}else{o=J.forward([n.Longitude,n.Latitude])}Z.set(o[0],o[1],n.Height);Z.sub(X);var l=new r.Euler(0,0,-(n.Heading+90)*Math.PI/180,"ZXY");K.position.copy(Z);K.rotation.copy(l);var c=C.getWorldDirection();var v=Math.atan2(c.x,c.y);var u=n.Heading*Math.PI/180;var f=u-v;if(y!=null){var m=y-f;var w=new r.Euler(0,0,m);var b=new r.Quaternion;b.setFromEuler(w);C.quaternion.premultiply(b)}C.position.copy(Z);Kr();_.children=[];var g={lon:n.Longitude,lat:n.Latitude,alt:n.Height};if(e.Historyframe!=null&&e.Historyframe.length>0){if(e.Nextframe==null){e.Nextframe=e.Historyframe.shift()}else if(e.Prevframe==null){e.Prevframe=e.Historyframe.shift()}}var x=new r.Vector3(0,1,0);var k=e.Nextframe;if(k!=null){var M=J.forward([k.Longitude,k.Latitude]);var c=new r.Vector3(M[0]-o[0],M[1]-o[1],0).normalize();var P=Math.atan2(c.x,c.y);var u=P*180/Math.PI;var L=new r.Group;_.add(L);L.rotation.set(0,0,-P);var T=fr(L,re,k.Id,16772846,ge(u));T.position.copy(x);x.z+=.01;g.next={id:k.Id,heading:u}}var k=e.Prevframe;if(k!=null){var M=J.forward([k.Longitude,k.Latitude]);var c=new r.Vector3(M[0]-o[0],M[1]-o[1],0).normalize();var P=Math.atan2(c.x,c.y);var u=P*180/Math.PI;var L=new r.Group;_.add(L);L.rotation.set(0,0,-P);var T=fr(L,re,k.Id,15663086,ge(u));T.position.copy(x);x.z+=.01;g.prev={id:k.Id,heading:u}}var S;if(e.Branchframe!=null){g.branch=[];for(var z=0;z<e.Branchframe.length;z++){var k=e.Branchframe[z];if(k!=null){var u=-k.Heading*Math.PI/180;var P=u*Math.PI/180;var V=Math.abs(n.Heading-k.Heading);while(V>360){V-=360}if(V>150){g.back={id:k.Id,heading:u};continue}var L=new r.Group;_.add(L);L.rotation.set(0,0,-P);var T=fr(L,re,k.Id,15658751,ge(u));T.position.copy(x);x.z+=.01;g.branch.push({id:k.Id,heading:u})}}}var F=false;if(e.Historyframe!=null){if(e.Historyframe.length>0){var T=fr(_,re,"history",16777215,be);T.scale.set(.7,.7,.7);T.userData=[];g.history=[];for(var z=0;z<e.Historyframe.length;z++){var k=e.Historyframe[z];if(k!=null){var I=n.Pictureurl;var M=I.lastIndexOf("/");var E=I.substr(0,M)+"/"+Ie.thumb+I.substr(M);var B={id:k.Id,date:k.Datetime,thumb:E,img:I};T.userData.push(B);var A={id:k.Id,date:k.Datetime};g.history.push(A)}}}}i.onPosition(g);if(i.needsUpdate){i.needsUpdate=false;for(var z=0;z<q.children.length;z++){var G=q.children[z];i.setLayer(G,G.userData)}}{var c=C.getWorldDirection();var u=Math.atan2(c.x,c.y)*180/Math.PI;var D=Math.asin(c.z)*180/Math.PI;var H=C.fov;var O=Math.atan(Math.tan(H/2)*C.aspect)*2*180/Math.PI;var N={heading:u,pitch:D,fovx:O,dir:c};i.onEye(N)}h=n.Id;var j={state:LocateState.success};i.onLocate(j);p=false;if(d){Ce(Ee(1))}}Vr()}i.PPV=s});